<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': '#067D87',
                        'primary-dark': '#B91C1C',
                        'secondary': '#EA580C',
                        'accent': '#F59E0B',
                        'success': '#10B981',
                        'neutral-500': '#6B7280',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { display: none;}
        body { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <title>Monitoramento Alerta Recife</title>
</head>
<body class="bg-gray-50 font-inter min-h-screen">

    <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-50 bg-white p-3 rounded-xl shadow-lg border border-gray-200">
        <i class="fa-solid fa-bars text-xl text-gray-700"></i>
    </button>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

    <aside id="sidebar" class="fixed left-0 top-0 w-72 h-screen bg-white border-r border-gray-200 shadow-xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Alerta Recife</h1>
                    <p class="text-sm text-gray-500">Sistema de Detec√ß√£o</p>
                </div>
                <button id="close-sidebar-btn" class="lg:hidden text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <nav class="space-y-3">
                <a href="dashboard.html" class="flex items-center space-x-4 px-4 py-4 rounded-xl text-gray-600 hover:bg-gray-100 transition-colors">
                    <i class="fa-solid fa-map text-lg"></i>
                    <span class="font-medium">Mapa</span>
                </a>
                <div class="flex items-center space-x-4 px-4 py-4 rounded-xl bg-primary text-white cursor-pointer shadow-lg">
                    <i class="fa-solid fa-database text-lg"></i>
                    <span class="font-semibold">Dados</span>
                </div>
                <a href="camera.html" class="flex items-center space-x-4 px-4 py-4 rounded-xl text-gray-600 hover:bg-gray-100 transition-colors">
                    <i class="fa-solid fa-camera text-lg"></i>
                    <span class="font-medium">C√¢meras</span>
                </a>
                <a href="historico.html" class="flex items-center space-x-4 px-4 py-4 rounded-xl text-gray-600 hover:bg-gray-100 transition-colors">
                    <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                    <span class="font-medium">Hist√≥rico</span>
                </a>
            </nav>
        </div>
        <div class="absolute bottom-6 left-6 right-6">
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-4 border border-primary/20">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-success rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium text-gray-700">Sistema Ativo</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Monitoramento em tempo real</p>
            </div>
        </div>
    </aside>

    <div id="alert-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-11/12 max-w-md scale-100 transition-all">
            <div class="flex items-center space-x-4 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-4xl text-primary-dark animate-pulse"></i>
                <h3 class="text-2xl font-bold text-gray-900">ALERTA DE SEGURAN√áA!</h3>
            </div>
            <p class="text-gray-700 mb-6">Ru√≠do Elevado e Impacto detectados!</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeAlertModal()" class="bg-gray-200 px-4 py-2 rounded-lg font-medium">Ignorar</button>
                <button onclick="window.location.href='camera.html'" class="bg-primary text-white px-4 py-2 rounded-lg font-medium">Ver C√¢mera</button>
            </div>
        </div>
    </div>

    <div class="lg:ml-72">
        <header id="header" class="bg-white border-b border-gray-200 px-4 sm:px-6 lg:px-8 py-4 lg:py-5 shadow-sm">
            <div class="flex justify-between items-center">
                <div class="ml-12 lg:ml-0">
                    <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">Painel de Sensores (Nuvem)</h2>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1 hidden sm:block">Monitoramento de Som, Temperatura e Impacto (ThingSpeak)</p>
                </div>
                <div class="flex items-center space-x-3 sm:space-x-6">
                    <div class="relative">
                        <i class="fa-regular fa-bell text-lg sm:text-xl text-gray-600 cursor-pointer hover:text-primary transition-colors"></i>
                        <span class="absolute -top-2 -right-2 w-4 h-4 sm:w-5 sm:h-5 bg-primary text-white text-xs rounded-full flex items-center justify-center">3</span>
                    </div>
                    <div class="relative">
                        <div class="flex items-center space-x-2 sm:space-x-3 cursor-pointer" onclick="toggleProfileMenu()">
                            <img src="https://www.publicdomainpictures.net/pictures/180000/velka/cat-1464103447LmK.jpg" class="w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 rounded-full border-3 border-primary shadow-md" alt="User Avatar">
                            <div class="hidden sm:block">
                                <p class="font-semibold text-gray-900 text-sm lg:text-base">lorena</p>
                                <p class="text-xs text-gray-500">governo</p>
                            </div>
                            <i class="fa-solid fa-chevron-down text-gray-400 text-xs sm:text-sm"></i>
                        </div>
                        
                        <div id="profile-menu" class="absolute right-0 top-full mt-2 w-56 sm:w-64 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50 hidden">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="font-semibold text-gray-900">Lorena</p>
                                <p class="text-sm text-gray-500">lorena@recife.gov.br</p>
                            </div>
                            <div class="py-2">
                                <a href="perfil.html" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fa-solid fa-gear text-gray-500 w-5"></i>
                                    <span class="ml-3 font-medium">Meu Perfil</span>
                                </a>
                                <a href="configuracoes.html" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors">
                                    <i class="fa-solid fa-gear text-gray-500 w-5"></i>
                                    <span class="ml-3 font-medium">Configura√ß√µes</span>
                                </a>
                                <div class="border-t border-gray-100 mt-2 pt-2">
                                    <a href="index.html" class="flex items-center px-4 py-3 text-red-600 hover:bg-red-50 transition-colors cursor-pointer">
                                        <i class="fa-solid fa-sign-out-alt text-red-500 w-5"></i>
                                        <span class="ml-3 font-medium">Sair</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <section id="sensor-live-data" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4 lg:gap-6 mb-8">
                
                <div id="card-sound" class="bg-white rounded-xl lg:rounded-2xl p-4 lg:p-6 shadow-xl border border-gray-200 transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs sm:text-sm font-medium">N√≠vel de Som (%)</p>
                            <p id="sound-value" class="text-3xl lg:text-4xl font-extrabold text-gray-900 mt-1 lg:mt-2">--</p>
                        </div>
                        <div class="w-14 h-14 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                            <i class="fa-solid fa-volume-up text-2xl"></i>
                        </div>
                    </div>
                    <p id="sound-status" class="text-sm font-semibold text-gray-500 mt-4">Carregando...</p>
                </div>

                <div id="card-temp" class="bg-white rounded-xl lg:rounded-2xl p-4 lg:p-6 shadow-xl border border-gray-200 transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs sm:text-sm font-medium">Temperatura (¬∫C)</p>
                            <p id="temp-value" class="text-3xl lg:text-4xl font-extrabold text-gray-900 mt-1 lg:mt-2">--</p>
                        </div>
                        <div class="w-14 h-14 bg-secondary/10 rounded-xl flex items-center justify-center text-secondary">
                            <i class="fa-solid fa-thermometer-half text-2xl"></i>
                        </div>
                    </div>
                    <p id="temp-status" class="text-sm font-semibold text-gray-500 mt-4">Carregando...</p>
                </div>

                <div id="card-impact" class="bg-white rounded-xl lg:rounded-2xl p-4 lg:p-6 shadow-xl border border-gray-200 transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs sm:text-sm font-medium">Status de Impacto</p>
                            <p id="impact-value" class="text-3xl lg:text-4xl font-extrabold text-gray-900 mt-1 lg:mt-2">--</p>
                        </div>
                        <div class="w-14 h-14 bg-accent/10 rounded-xl flex items-center justify-center text-accent">
                            <i class="fa-solid fa-bolt text-2xl"></i>
                        </div>
                    </div>
                    <p id="impact-status" class="text-sm font-semibold text-gray-500 mt-4">Carregando...</p>
                </div>
                
                <div class="bg-white rounded-xl lg:rounded-2xl p-4 lg:p-6 shadow-xl border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs sm:text-sm font-medium">Status do Servidor</p>
                            <p id="cloud-status" class="text-3xl lg:text-4xl font-extrabold text-success mt-1 lg:mt-2">ONLINE</p>
                        </div>
                        <div class="w-14 h-14 bg-success/10 rounded-xl flex items-center justify-center text-success">
                            <i class="fa-solid fa-cloud text-2xl"></i>
                        </div>
                    </div>
                    <p class="text-sm font-semibold text-success mt-4">√öltima atualiza√ß√£o: <span id="last-update" class="font-bold">--</span></p>
                </div>

            </section>
        </main>
    </div>

    <script>
        // =======================================================
        // === CONFIGURA√á√ïES DO THINGSPEAK (AJUSTE AQUI) ===
        // =======================================================
        const CHANNEL_ID = '3202067'; // ‚ö†Ô∏è SEU ID NUM√âRICO DO CANAL
        const READ_API_KEY = '1WJUIXDFNEVTTPYP'; // ‚ö†Ô∏è SUA CHAVE DE LEITURA
        const URL = `https://api.thingspeak.com/channels/3202067/feeds/last.json?api_key=1WJUIXDFNEVTTPYP`;
        
        const LIMITE_RUIDO_PERCENTUAL = 70;
        let isAlertOpen = false;

        // Fun√ß√µes de Utilit√°rio e Alerta
        function closeAlertModal() {
            document.getElementById('alert-modal').classList.add('hidden');
            isAlertOpen = false;
        }

        function updateStatusClasses(element, removeClasses, addClasses) {
            if (!element) return;
            if (removeClasses) {
                element.classList.remove(...removeClasses.split(' '));
            }
            if (addClasses) {
                element.classList.add(...addClasses.split(' '));
            }
        }

        // Fun√ß√µes do Menu Lateral (A√ß√µes)
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            });
            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });
        });

        // Profile menu toggle functionality (A√ß√µes)
        function toggleProfileMenu() {
            const profileMenu = document.getElementById('profile-menu');
            profileMenu.classList.toggle('hidden');
        }

        document.addEventListener('click', function(event) {
            const profileMenu = document.getElementById('profile-menu');
            const profileButton = event.target.closest('[onclick="toggleProfileMenu()"]');
            
            if (profileMenu && !profileButton && !profileMenu.contains(event.target)) {
                profileMenu.classList.add('hidden');
            }
        });
        
        // =======================================================
        // === FUN√á√ÉO PRINCIPAL DE LEITURA DO THINGSPEAK ===
        // =======================================================
        function fetchSensorData() {
            fetch(URL)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na requisi√ß√£o: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    if(!data || data.field1 === null) {
                         // Se a resposta for vazia mas OK, ainda mostramos OFFLINE
                         document.getElementById('cloud-status').textContent = "OFFLINE";
                         throw new Error("Dados vazios ou nulos recebidos do ThingSpeak.");
                    }

                    const now = new Date();
                    document.getElementById('last-update').textContent = now.toLocaleTimeString();
                    document.getElementById('cloud-status').textContent = "ONLINE";
                    updateStatusClasses(document.getElementById('cloud-status'), 'text-primary-dark', 'text-success'); // Garante cor verde
                    
                    // --- Mapeamento dos Dados ---
                    const soundRaw = parseInt(data.field1) || 0;
                    const tempIsNan = data.field2 === "nan" || data.field2 === null; 
                    const tempVal = tempIsNan ? null : parseFloat(data.field2).toFixed(1);
                    const isImpact = data.field3 === "1"; 

                    // Convers√£o para Percentual
                    const soundPerc = Math.min(Math.round((soundRaw / 4095) * 100), 100);
                    const isLoud = soundPerc > LIMITE_RUIDO_PERCENTUAL;

                    // --- ATUALIZA√á√ÉO VISUAL ---

                    // 1. Som
                    document.getElementById('sound-value').textContent = soundPerc + '%';
                    const soundStatusEl = document.getElementById('sound-status');
                    soundStatusEl.textContent = isLoud ? 'Ru√≠do Elevado' : 'N√≠vel Normal';
                    updateStatusClasses(soundStatusEl, isLoud ? 'text-gray-500' : 'text-secondary', isLoud ? 'text-secondary' : 'text-gray-500');

                    // 2. Temperatura (Tratamento de Erro e Alerta)
                    const tempStatusEl = document.getElementById('temp-status');
                    const tempCard = document.getElementById('card-temp');
                    
                    if (tempIsNan || tempVal === null) {
                        document.getElementById('temp-value').textContent = '--';
                        tempStatusEl.textContent = 'Erro de Leitura';
                        updateStatusClasses(tempStatusEl, 'text-gray-500', 'text-primary-dark');
                        updateStatusClasses(tempCard, 'ring-2 ring-primary-dark/50', 'border-gray-200'); // Destaca erro
                    } else {
                        document.getElementById('temp-value').textContent = tempVal + ' ¬∫C';
                        const isHot = tempVal > 40;
                        tempStatusEl.textContent = isHot ? 'Temperatura ALTA' : 'Temperatura OK';
                        updateStatusClasses(tempStatusEl, isHot ? 'text-gray-500' : 'text-primary-dark', isHot ? 'text-primary-dark' : 'text-gray-500');
                        
                        if(isHot) updateStatusClasses(tempCard, 'border-gray-200', 'ring-2 ring-primary-dark/50');
                        else updateStatusClasses(tempCard, 'ring-2 ring-primary-dark/50', 'border-gray-200');
                    }

                    // 3. Impacto
                    const impactStatusEl = document.getElementById('impact-status');
                    const impactCard = document.getElementById('card-impact');
                    document.getElementById('impact-value').textContent = isImpact ? 'DETECTADO!' : 'Nenhum';
                    impactStatusEl.textContent = isImpact ? 'A√ß√£o Necess√°ria' : 'Monitorando';
                    updateStatusClasses(impactStatusEl, isImpact ? 'text-gray-500' : 'text-accent', isImpact ? 'text-accent' : 'text-gray-500');

                    if(isImpact) updateStatusClasses(impactCard, 'border-gray-200', 'ring-2 ring-accent/50');
                    else updateStatusClasses(impactCard, 'ring-2 ring-accent/50', 'border-gray-200');

                    // üö® 4. L√ìGICA POPUP üö®
                    if (isLoud && isImpact && !isAlertOpen) {
                        document.getElementById('alert-modal').classList.remove('hidden');
                        isAlertOpen = true;
                    }
                })
                .catch(err => {
                    console.error("Erro ao buscar do ThingSpeak:", err);
                    
                    // L√≥gica de Falha de Conex√£o
                    document.getElementById('cloud-status').textContent = "OFFLINE";
                    document.getElementById('cloud-status').className = "text-3xl lg:text-4xl font-extrabold text-primary-dark mt-1 lg:mt-2";
                    document.getElementById('last-update').textContent = 'FALHA (' + new Date().toLocaleTimeString() + ')';
                    
                    // Resetar os valores para '--' em caso de erro
                    document.getElementById('sound-value').textContent = '--';
                    document.getElementById('temp-value').textContent = '--';
                    document.getElementById('impact-value').textContent = '--';
                    document.getElementById('sound-status').textContent = 'Sem Dados';
                    document.getElementById('temp-status').textContent = 'Sem Dados';
                    document.getElementById('impact-status').textContent = 'Sem Dados';
                });
        }

        // Inicia o Polling
        document.addEventListener('DOMContentLoaded', () => {
            fetchSensorData();
            setInterval(fetchSensorData, 5000); 
        });
    </script>
</body>
</html>
